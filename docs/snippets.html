<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>C Snippets | Collaborative Data Science Practices</title>
<meta name="author" content="Will Beasley">
<meta name="description" content="C.1 Reading External Data  C.1.1 Reading from Excel Background: Avoid Excel for the reasons previously discussed. But if there isn’t another good option, be protective. readxl::read_excel() allows...">
<meta name="generator" content="bookdown 0.29 with bs4_book()">
<meta property="og:title" content="C Snippets | Collaborative Data Science Practices">
<meta property="og:type" content="book">
<meta property="og:description" content="C.1 Reading External Data  C.1.1 Reading from Excel Background: Avoid Excel for the reasons previously discussed. But if there isn’t another good option, be protective. readxl::read_excel() allows...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="C Snippets | Collaborative Data Science Practices">
<meta name="twitter:description" content="C.1 Reading External Data  C.1.1 Reading from Excel Background: Avoid Excel for the reasons previously discussed. But if there isn’t another good option, be protective. readxl::read_excel() allows...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.1/transition.js"></script><script src="libs/bs3compat-0.4.1/tabs.js"></script><script src="libs/bs3compat-0.4.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
<link rel="stylesheet" href="bs4_style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Collaborative Data Science Practices</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"><span class="header-section-number">1</span> Introduction</a></li>
<li><a class="" href="coding.html"><span class="header-section-number">2</span> Coding Principles</a></li>
<li><a class="" href="architecture.html"><span class="header-section-number">3</span> Architecture Principles</a></li>
<li><a class="" href="prototype-r.html"><span class="header-section-number">4</span> Prototypical R File</a></li>
<li><a class="" href="prototype-sql.html"><span class="header-section-number">5</span> Prototypical SQL File</a></li>
<li><a class="" href="prototype-repo.html"><span class="header-section-number">6</span> Prototypical Repository</a></li>
<li><a class="" href="rest.html"><span class="header-section-number">7</span> Data at Rest</a></li>
<li><a class="" href="patterns.html"><span class="header-section-number">8</span> Patterns</a></li>
<li><a class="" href="security.html"><span class="header-section-number">9</span> Security &amp; Private Data</a></li>
<li><a class="" href="automation.html"><span class="header-section-number">10</span> Automation &amp; Reproducibility</a></li>
<li><a class="" href="scaling-up.html"><span class="header-section-number">11</span> Scaling Up</a></li>
<li><a class="" href="collaboration.html"><span class="header-section-number">12</span> Parallel Collaboration</a></li>
<li><a class="" href="document.html"><span class="header-section-number">13</span> Documentation</a></li>
<li><a class="" href="style.html"><span class="header-section-number">14</span> Style Guide</a></li>
<li><a class="" href="publication.html"><span class="header-section-number">15</span> Publishing Results</a></li>
<li><a class="" href="validation.html"><span class="header-section-number">16</span> Validation</a></li>
<li><a class="" href="testing.html"><span class="header-section-number">17</span> Testing</a></li>
<li><a class="" href="troubleshooting.html"><span class="header-section-number">18</span> Troubleshooting and Debugging</a></li>
<li><a class="" href="workstation.html"><span class="header-section-number">19</span> Workstation</a></li>
<li><a class="" href="tools.html"><span class="header-section-number">20</span> Considerations when Selecting Tools</a></li>
<li><a class="" href="team.html"><span class="header-section-number">21</span> Growing a Team</a></li>
<li><a class="" href="redcap-user.html"><span class="header-section-number">22</span> Material for REDCap Users</a></li>
<li><a class="" href="redcap-developer.html"><span class="header-section-number">23</span> Material for REDCap Developers</a></li>
<li><a class="" href="redcap-admin.html"><span class="header-section-number">24</span> Material for REDCap Admins</a></li>
<li class="book-part">Appendix</li>
<li><a class="" href="git.html"><span class="header-section-number">A</span> Git &amp; GitHub</a></li>
<li><a class="" href="regex.html"><span class="header-section-number">B</span> Regular Expressions</a></li>
<li><a class="active" href="snippets.html"><span class="header-section-number">C</span> Snippets</a></li>
<li><a class="" href="presentations.html"><span class="header-section-number">D</span> Presentations</a></li>
<li><a class="" href="scratch-pad.html"><span class="header-section-number">E</span> Scratch Pad of Loose Ideas</a></li>
<li><a class="" href="example-dashboard.html"><span class="header-section-number">F</span> Example Dashboard</a></li>
<li><a class="" href="example-chapter.html"><span class="header-section-number">G</span> Example Chapter</a></li>
<li><a class="" href="acknowledgements.html"><span class="header-section-number">H</span> Acknowledgements</a></li>
<li><a class="" href="references.html"><span class="header-section-number">I</span> References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/OuhscBbmc/data-science-practices-1">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="snippets" class="section level1" number="27">
<h1>
<span class="header-section-number">C</span> Snippets<a class="anchor" aria-label="anchor" href="#snippets"><i class="fas fa-link"></i></a>
</h1>
<div id="snippets-reading" class="section level2" number="27.1">
<h2>
<span class="header-section-number">C.1</span> Reading External Data<a class="anchor" aria-label="anchor" href="#snippets-reading"><i class="fas fa-link"></i></a>
</h2>
<div id="snippets-reading-excel" class="section level3" number="27.1.1">
<h3>
<span class="header-section-number">C.1.1</span> Reading from Excel<a class="anchor" aria-label="anchor" href="#snippets-reading-excel"><i class="fas fa-link"></i></a>
</h3>
<p><em>Background</em>: Avoid Excel for the <a href="%7B#data-containers-avoid">reasons previously discussed</a>. But if there isn’t another good option, be protective. <a href="https://readxl.tidyverse.org/reference/read_excel.html"><code>readxl::read_excel()</code></a> allows you to specify column types, but not column order. The names of <code>col_types</code> is ignored by <code>readxl::read_excel()</code>. To defend against roaming columns (<em>e.g.</em>, the files changed over time), <code>tesit::assert()</code> that the order is what you expect.</p>
<p>See the readxl vignette, <a href="https://readxl.tidyverse.org/articles/cell-and-column-types.html">Cell and Column Types</a>, for more info.</p>
<p><em>Last Modified</em>: 2019-12-12 by Will</p>
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ---- declare-globals ---------------------------------------------------------</span></span>
<span><span class="va">config</span>                         <span class="op">&lt;-</span> <span class="fu">config</span><span class="fu">::</span><span class="fu">get</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># cat(sprintf('  `%s`             = "text",\n', colnames(ds)), sep="") # 'text' by default --then change where appropriate.</span></span>
<span><span class="va">col_types</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>  `Med Rec Num`     <span class="op">=</span> <span class="st">"text"</span>,</span>
<span>  `Admit Date`      <span class="op">=</span> <span class="st">"date"</span>,</span>
<span>  `Tot Cash Pymt`   <span class="op">=</span> <span class="st">"numeric"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ---- load-data ---------------------------------------------------------------</span></span>
<span><span class="va">ds</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu">read_excel</span><span class="op">(</span></span>
<span>  path      <span class="op">=</span> <span class="va">config</span><span class="op">$</span><span class="va">path_admission_charge</span>,</span>
<span>  col_types <span class="op">=</span> <span class="va">col_types</span></span>
<span>  <span class="co"># sheet   = "dont-use-sheets-if-possible"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">testit</span><span class="fu">::</span><span class="fu">assert</span><span class="op">(</span></span>
<span>  <span class="st">"The order of column names must match the expected list."</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">col_types</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">ds</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div id="snippets-reading-trailing-comma" class="section level3" number="27.1.2">
<h3>
<span class="header-section-number">C.1.2</span> Removing Trailing Comma from Header<a class="anchor" aria-label="anchor" href="#snippets-reading-trailing-comma"><i class="fas fa-link"></i></a>
</h3>
<p><em>Background</em>: Occasionally a Meditech Extract will have an extra comma at the end of the 1st line. For each subsequent line, <a href="https://readr.tidyverse.org/reference/read_delim.html"><code>readr:read_csv()</code></a> appropriately throws a new warning that it is missing a column. This warning flood can mask real problems.</p>
<p><em>Explanation</em>: This snippet (a) reads the csv as plain text, (b) removes the final comma, and (c) passes the plain text to <code>readr::read_csv()</code> to convert it into a data.frame.</p>
<p><em>Instruction</em>: Modify <code>Dx50 Name</code> to the name of the final (real) column.</p>
<p><em>Real Example</em>: <a href="https://github.com/OuhscBbmc/truong-pharmacist-transition-1/blob/eec6d7eb8aaa9e3df52dafb826dbc53aaf515c63/manipulation/ellis/dx-ellis.R#L158-L162">truong-pharmacist-transition-1</a> (Accessible to only CDW members.)</p>
<p><em>Last Modified</em>: 2019-12-12 by Will</p>
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># The next two lines remove the trailing comma at the end of the 1st line.</span></span>
<span><span class="va">raw_text</span>  <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu">read_file</span><span class="op">(</span><span class="va">path_in</span><span class="op">)</span></span>
<span><span class="va">raw_text</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">sub</a></span><span class="op">(</span><span class="st">"^(.+Dx50 Name),"</span>, <span class="st">"\\1"</span>, <span class="va">raw_text</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ds</span>        <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu">read_csv</span><span class="op">(</span><span class="va">raw_text</span>, col_types<span class="op">=</span><span class="va">col_types</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="snippets-reading-vroom" class="section level3" number="27.1.3">
<h3>
<span class="header-section-number">C.1.3</span> Removing Trailing Comma from Header<a class="anchor" aria-label="anchor" href="#snippets-reading-vroom"><i class="fas fa-link"></i></a>
</h3>
<p><em>Background</em>: When incoming data files are on the large side to comfortably accept with <a href="https://readr.tidyverse.org/">readr</a>, we use <a href="https://vroom.r-lib.org/">vroom</a>. The two packages are developed by the same group and <a href="https://github.com/tidyverse/tidyverse.org/pull/375#issuecomment-564781603">might be combined</a> in the future.</p>
<p><em>Explanation</em>: This snippet defines the <code>col_types</code> list with names to mimic <a href="https://ouhscbbmc.github.io/data-science-practices-1/prototype-r.html#chunk-declare">our approach</a> of using readr. There are some small differences with our readr approach:
1. <code>col_types</code> is a <a href="https://stat.ethz.ch/R-manual/R-devel/library/base/html/list.html">list</a> instead of a <a href="https://readr.tidyverse.org/reference/cols.html"><code>readr::cols_only</code></a> object.
1. The call to <a href="https://vroom.r-lib.org/reference/vroom.html"><code>vroom::vroom()</code></a> passes <code>col_names = names(col_types)</code> explicitly.
1. If the data file contains columns we don’t need, we define them in <code>col_types</code> anyway; vroom needs to know the file structure if it’s missing a header row.</p>
<p><em>Real Example</em>: <a href="https://github.com/OuhscBbmc/akande-medically-complex-1/tree/main/manipulation/ohca">akande-medically-complex-1</a> (Accessible to only CDW members.) Thesee files did not have a header of variable names; the first line of the file is the first data row.</p>
<p><em>Last Modified</em>: 2020-08-21 by Will</p>
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ---- declare-globals ---------------------------------------------------------</span></span>
<span><span class="va">config</span>            <span class="op">&lt;-</span> <span class="fu">config</span><span class="fu">::</span><span class="fu">get</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">col_types</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  sak                      <span class="op">=</span> <span class="fu">vroom</span><span class="fu">::</span><span class="fu">col_integer</span><span class="op">(</span><span class="op">)</span>,  <span class="co"># "system-assigned key"</span></span>
<span>  aid_category_id          <span class="op">=</span> <span class="fu">vroom</span><span class="fu">::</span><span class="fu">col_character</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  age                      <span class="op">=</span> <span class="fu">vroom</span><span class="fu">::</span><span class="fu">col_integer</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  service_date_first       <span class="op">=</span> <span class="fu">vroom</span><span class="fu">::</span><span class="fu">col_date</span><span class="op">(</span><span class="st">"%m/%d/%Y"</span><span class="op">)</span>,</span>
<span>  service_date_lasst       <span class="op">=</span> <span class="fu">vroom</span><span class="fu">::</span><span class="fu">col_date</span><span class="op">(</span><span class="st">"%m/%d/%Y"</span><span class="op">)</span>,</span>
<span>  claim_type               <span class="op">=</span> <span class="fu">vroom</span><span class="fu">::</span><span class="fu">col_character</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  provider_id              <span class="op">=</span> <span class="fu">vroom</span><span class="fu">::</span><span class="fu">col_character</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  provider_lat             <span class="op">=</span> <span class="fu">vroom</span><span class="fu">::</span><span class="fu">col_double</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  provider_long            <span class="op">=</span> <span class="fu">vroom</span><span class="fu">::</span><span class="fu">col_double</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  provider_zip             <span class="op">=</span> <span class="fu">vroom</span><span class="fu">::</span><span class="fu">col_character</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  cpt                      <span class="op">=</span> <span class="fu">vroom</span><span class="fu">::</span><span class="fu">col_integer</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  revenue_code             <span class="op">=</span> <span class="fu">vroom</span><span class="fu">::</span><span class="fu">col_integer</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  icd_code                 <span class="op">=</span> <span class="fu">vroom</span><span class="fu">::</span><span class="fu">col_character</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  icd_sequence             <span class="op">=</span> <span class="fu">vroom</span><span class="fu">::</span><span class="fu">col_integer</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  vocabulary_coarse_id     <span class="op">=</span> <span class="fu">vroom</span><span class="fu">::</span><span class="fu">col_integer</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ---- load-data ---------------------------------------------------------------</span></span>
<span><span class="va">ds</span> <span class="op">&lt;-</span> <span class="fu">vroom</span><span class="fu">::</span><span class="fu">vroom</span><span class="op">(</span></span>
<span>  file      <span class="op">=</span> <span class="va">config</span><span class="op">$</span><span class="va">path_ohca_patient</span>,</span>
<span>  delim     <span class="op">=</span> <span class="st">"\t"</span>,</span>
<span>  col_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">col_types</span><span class="op">)</span>,</span>
<span>  col_types <span class="op">=</span> <span class="va">col_types</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">col_types</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div id="snippets-grooming" class="section level2" number="27.2">
<h2>
<span class="header-section-number">C.2</span> Grooming<a class="anchor" aria-label="anchor" href="#snippets-grooming"><i class="fas fa-link"></i></a>
</h2>
<div id="snippets-grooming-two-year" class="section level3" number="27.2.1">
<h3>
<span class="header-section-number">C.2.1</span> Correct for misinterpreted two-digit year<a class="anchor" aria-label="anchor" href="#snippets-grooming-two-year"><i class="fas fa-link"></i></a>
</h3>
<p><em>Background</em>: Sometimes the Meditech dates are specified like <code>1/6/54</code> instead of <code>1/6/1954</code>. <code>readr::read_csv()</code> has to choose if the year is supposed to be ‘1954’ or ‘2054’. A human can use context to guess a birth date is in the past (so it guesses 1954), but readr can’t (so it guesses 2054). For avoid this and other problems, request dates in an <a href="https://www.explainxkcd.com/wiki/index.php/1179:_ISO_8601">ISO-8601</a> format.</p>
<p><em>Explanation</em>: Correct for this in a <code>dplyr::mutate()</code> clause; compare the date value against today. If the date is today or before, use it; if the day is in the future, subtract 100 years.</p>
<p><em>Instruction</em>: For future dates such as loan payments, the direction will flip.</p>
<p><em>Last Modified</em>: 2019-12-12 by Will</p>
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span> <span class="va">ds</span> <span class="op">|&gt;</span></span>
<span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu">mutate</span><span class="op">(</span></span>
<span>    dob <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu">if_else</span><span class="op">(</span><span class="va">dob</span> <span class="op">&lt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">dob</span>, <span class="va">dob</span> <span class="op">-</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu">years</span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
</div>
<div id="snippets-identification" class="section level2" number="27.3">
<h2>
<span class="header-section-number">C.3</span> Identification<a class="anchor" aria-label="anchor" href="#snippets-identification"><i class="fas fa-link"></i></a>
</h2>
<div id="snippets-identification-tags" class="section level3" number="27.3.1">
<h3>
<span class="header-section-number">C.3.1</span> Generating “tags”<a class="anchor" aria-label="anchor" href="#snippets-identification-tags"><i class="fas fa-link"></i></a>
</h3>
<p><em>Background</em>: When you need to generate unique identification values for future people/clients/patients, as described in the <a href="style.html#style-number">style guide</a>.</p>
<p><em>Explanation</em>: This snippet will create a 5-row csv with random 7-character “tags” to send to the research team collecting patients. The</p>
<p><em>Instruction</em>: Set <code>pt_count</code>, <code>tag_length</code>, <code>path_out</code>, and execute. Add and rename the columns to be more appropriate for your domain (<em>e.g.</em>, change “patient tag” to “store tag”).</p>
<p><em>Last Modified</em>: 2019-12-30 by Will</p>
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pt_count</span>    <span class="op">&lt;-</span> <span class="fl">5L</span>   <span class="co"># The number of rows in the dataset.</span></span>
<span><span class="va">tag_length</span>  <span class="op">&lt;-</span> <span class="fl">7L</span>   <span class="co"># The number of characters in each tag.</span></span>
<span><span class="va">path_out</span>    <span class="op">&lt;-</span> <span class="st">"data-private/derived/pt-pool.csv"</span></span>
<span></span>
<span><span class="va">draw_tag</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">tag_length</span> <span class="op">=</span> <span class="fl">4L</span>, <span class="va">urn</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">9</span>, <span class="va">letters</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">urn</span>, size <span class="op">=</span> <span class="va">tag_length</span>, replace <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">ds_pt_pool</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>    pt_index    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">pt_count</span><span class="op">)</span>,</span>
<span>    pt_tag      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">tag_length</span>, <span class="va">pt_count</span><span class="op">)</span>, <span class="va">draw_tag</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    assigned    <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    name_last   <span class="op">=</span> <span class="st">"--"</span>,</span>
<span>    name_first  <span class="op">=</span> <span class="st">"--"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu">readr</span><span class="fu">::</span><span class="fu">write_csv</span><span class="op">(</span><span class="va">ds_pt_pool</span>, <span class="va">path_out</span><span class="op">)</span></span></code></pre></div>
<p>The resulting dataset will look like this, but with different randomly-generated tags.</p>
<pre class="csv"><code># A tibble: 5 x 5
  pt_index pt_tag  assigned name_last name_first
     &lt;int&gt; &lt;chr&gt;   &lt;lgl&gt;    &lt;chr&gt;     &lt;chr&gt;
1        1 seikyfr FALSE    --        --
2        2 voiix4l FALSE    --        --
3        3 wosn4w2 FALSE    --        --
4        4 jl0dg84 FALSE    --        --
5        5 r5ei5ph FALSE    --        --</code></pre>
</div>
</div>
<div id="snippets-correspondence" class="section level2" number="27.4">
<h2>
<span class="header-section-number">C.4</span> Correspondence with Collaborators<a class="anchor" aria-label="anchor" href="#snippets-correspondence"><i class="fas fa-link"></i></a>
</h2>
<div id="snippets-correspondence-excel" class="section level3" number="27.4.1">
<h3>
<span class="header-section-number">C.4.1</span> Excel files<a class="anchor" aria-label="anchor" href="#snippets-correspondence-excel"><i class="fas fa-link"></i></a>
</h3>
<p>Receiving and storing <a href="#data-containers-avoid">Excel files should almost always be avoided</a> for the reasons explained in this letter.</p>
<p>We receive extracts as Excel files frequently, and have the following request ready to email the person sending us Excel files. Adapt the bold values like “109.19” to your situation. If you are familiar with their tools, suggest an alternative for saving the file as a csv. Once presented with these Excel gotchas, almost everyone has an ‘aha’ moment and recognizes the problem. Unfortunately, not everyone has flexible software and can adapt easily.</p>
<hr>
<p>[Start of the letter]</p>
<p>Sorry to be tedious, but could you please resend the extract as a <a href="https://en.wikipedia.org/wiki/Comma-separated_values">csv</a> file? Please call me if you have questions.</p>
<p>Excel is being too helpful with some of the values, and essentially corrupting them. For example, values like <strong>109.19</strong> is interpreted as a number, not a character code (<em>e.g.</em>, see cell <strong>L14</strong>). Because of <a href="https://docs.oracle.com/cd/E19957-01/806-3568/ncg_goldberg.html">limitations of finite precision</a>, this becomes <strong>109.18999999999999773</strong>. We can’t round it, because there are other values in this column that cannot be cast to numbers, such as <strong>V55.0</strong>. Furthermore, the “E”s in some codes are incorrectly interpreted as the exponent operator (<em>e.g.</em>, “4E5” is converted to 400,000). Finally, values like <strong>41.0</strong> are being converted to a number and the trailing zero is dropped (so cells like “41” are not distinguishable from “41.0”).</p>
<p>Unfortunately the problems exist in the Excel file itself. When we import the columns <a href="https://readxl.tidyverse.org/reference/read_excel.html">as text</a>, the values are already in their corrupted state.</p>
<p>Please compress/zip the csv if the file is be too large to email. We’ve found that an Excel file is typically 5-10 times larger than a compressed csv.</p>
<p>As much as Excel interferes with our medical variables, we’re lucky. It has messed with other branches of science much worse. Genomics were using it far too late <a href="https://qz.com/768334/years-of-genomics-research-is-riddled-with-errors-thanks-to-a-bunch-of-botched-excel-spreadsheets/">before they realized their mistakes</a>.</p>
<blockquote>
<p>What happened? By default, Excel and other popular spreadsheet applications convert some gene symbols to dates and numbers. For example, instead of writing out “Membrane-Associated Ring Finger (C3HC4) 1, E3 Ubiquitin Protein Ligase,” researchers have dubbed the gene MARCH1. Excel converts this into a date—03/01/2016, say—because that’s probably what the majority of spreadsheet users mean when they type it into a cell. Similarly, gene identifiers like “2310009E13” are converted to exponential numbers (2.31E+19). In both cases, the conversions strip out valuable information about the genes in question.</p>
</blockquote>
<p>[End of the letter]</p>

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="regex.html"><span class="header-section-number">B</span> Regular Expressions</a></div>
<div class="next"><a href="presentations.html"><span class="header-section-number">D</span> Presentations</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#snippets"><span class="header-section-number">C</span> Snippets</a></li>
<li>
<a class="nav-link" href="#snippets-reading"><span class="header-section-number">C.1</span> Reading External Data</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#snippets-reading-excel"><span class="header-section-number">C.1.1</span> Reading from Excel</a></li>
<li><a class="nav-link" href="#snippets-reading-trailing-comma"><span class="header-section-number">C.1.2</span> Removing Trailing Comma from Header</a></li>
<li><a class="nav-link" href="#snippets-reading-vroom"><span class="header-section-number">C.1.3</span> Removing Trailing Comma from Header</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#snippets-grooming"><span class="header-section-number">C.2</span> Grooming</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#snippets-grooming-two-year"><span class="header-section-number">C.2.1</span> Correct for misinterpreted two-digit year</a></li></ul>
</li>
<li>
<a class="nav-link" href="#snippets-identification"><span class="header-section-number">C.3</span> Identification</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#snippets-identification-tags"><span class="header-section-number">C.3.1</span> Generating “tags”</a></li></ul>
</li>
<li>
<a class="nav-link" href="#snippets-correspondence"><span class="header-section-number">C.4</span> Correspondence with Collaborators</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#snippets-correspondence-excel"><span class="header-section-number">C.4.1</span> Excel files</a></li></ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/OuhscBbmc/data-science-practices-1/blob/main/ch-snippets.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/OuhscBbmc/data-science-practices-1/edit/main/ch-snippets.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Collaborative Data Science Practices</strong>" was written by Will Beasley. It was last built on 2022-11-08.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
