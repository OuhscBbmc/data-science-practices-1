<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 4 Prototypical R File | Collaborative Data Science Practices</title>
<meta name="author" content="Will Beasley">
<meta name="description" content="As stated in Consistency across Files, using a consistent file structure can (a) improve the quality of the code because the structure has been proven over time to facilitate good practices and...">
<meta name="generator" content="bookdown 0.37 with bs4_book()">
<meta property="og:title" content="Chapter 4 Prototypical R File | Collaborative Data Science Practices">
<meta property="og:type" content="book">
<meta property="og:description" content="As stated in Consistency across Files, using a consistent file structure can (a) improve the quality of the code because the structure has been proven over time to facilitate good practices and...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 4 Prototypical R File | Collaborative Data Science Practices">
<meta name="twitter:description" content="As stated in Consistency across Files, using a consistent file structure can (a) improve the quality of the code because the structure has been proven over time to facilitate good practices and...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.6.1/transition.js"></script><script src="libs/bs3compat-0.6.1/tabs.js"></script><script src="libs/bs3compat-0.6.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
<link rel="stylesheet" href="bs4_style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Collaborative Data Science Practices</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"><span class="header-section-number">1</span> Introduction</a></li>
<li><a class="" href="coding.html"><span class="header-section-number">2</span> Coding Principles</a></li>
<li><a class="" href="architecture.html"><span class="header-section-number">3</span> Architecture Principles</a></li>
<li><a class="active" href="prototype-r.html"><span class="header-section-number">4</span> Prototypical R File</a></li>
<li><a class="" href="prototype-sql.html"><span class="header-section-number">5</span> Prototypical SQL File</a></li>
<li><a class="" href="prototype-repo.html"><span class="header-section-number">6</span> Prototypical Repository</a></li>
<li><a class="" href="rest.html"><span class="header-section-number">7</span> Data at Rest</a></li>
<li><a class="" href="patterns.html"><span class="header-section-number">8</span> Patterns</a></li>
<li><a class="" href="security.html"><span class="header-section-number">9</span> Security &amp; Private Data</a></li>
<li><a class="" href="automation.html"><span class="header-section-number">10</span> Automation &amp; Reproducibility</a></li>
<li><a class="" href="scaling-up.html"><span class="header-section-number">11</span> Scaling Up</a></li>
<li><a class="" href="collaboration.html"><span class="header-section-number">12</span> Parallel Collaboration</a></li>
<li><a class="" href="document.html"><span class="header-section-number">13</span> Documentation</a></li>
<li><a class="" href="style.html"><span class="header-section-number">14</span> Style Guide</a></li>
<li><a class="" href="publication.html"><span class="header-section-number">15</span> Publishing Results</a></li>
<li><a class="" href="validation.html"><span class="header-section-number">16</span> Validation</a></li>
<li><a class="" href="testing.html"><span class="header-section-number">17</span> Testing</a></li>
<li><a class="" href="troubleshooting.html"><span class="header-section-number">18</span> Troubleshooting and Debugging</a></li>
<li><a class="" href="workstation.html"><span class="header-section-number">19</span> Workstation</a></li>
<li><a class="" href="tools.html"><span class="header-section-number">20</span> Considerations when Selecting Tools</a></li>
<li><a class="" href="team.html"><span class="header-section-number">21</span> Growing a Team</a></li>
<li><a class="" href="redcap-user.html"><span class="header-section-number">22</span> Material for REDCap Users</a></li>
<li><a class="" href="redcap-developer.html"><span class="header-section-number">23</span> Material for REDCap Developers</a></li>
<li><a class="" href="redcap-admin.html"><span class="header-section-number">24</span> Material for REDCap Admins</a></li>
<li class="book-part">Appendix</li>
<li><a class="" href="git.html"><span class="header-section-number">A</span> Git &amp; GitHub</a></li>
<li><a class="" href="regex.html"><span class="header-section-number">B</span> Regular Expressions</a></li>
<li><a class="" href="snippets.html"><span class="header-section-number">C</span> Snippets</a></li>
<li><a class="" href="presentations.html"><span class="header-section-number">D</span> Presentations</a></li>
<li><a class="" href="scratch-pad.html"><span class="header-section-number">E</span> Scratch Pad of Loose Ideas</a></li>
<li><a class="" href="example-dashboard.html"><span class="header-section-number">F</span> Example Dashboard</a></li>
<li><a class="" href="example-chapter.html"><span class="header-section-number">G</span> Example Chapter</a></li>
<li><a class="" href="acknowledgements.html"><span class="header-section-number">H</span> Acknowledgements</a></li>
<li><a class="" href="references.html"><span class="header-section-number">I</span> References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/OuhscBbmc/data-science-practices-1">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="prototype-r" class="section level1" number="4">
<h1>
<span class="header-section-number">4</span> Prototypical R File<a class="anchor" aria-label="anchor" href="#prototype-r"><i class="fas fa-link"></i></a>
</h1>
<p>As stated in <a href="architecture.html#consistency-files">Consistency across Files</a>, using a consistent file structure can (a) improve the quality of the code because the structure has been proven over time to facilitate good practices and (b) allow your intentions to be more clear to teammates because they are familiar with the order and intentions of the chunks.</p>
<p>We use the term “chunk” for a section of code because it corresponds with knitr terminology <span class="citation">(<a href="references.html#ref-xie2015" role="doc-biblioref">Xie 2015</a>)</span>, and in many analysis files (as opposed to manipulation files), the chunk of our R file connects to a knitr Rmd file.</p>
<div id="chunk-clear" class="section level2" number="4.1">
<h2>
<span class="header-section-number">4.1</span> Clear Memory<a class="anchor" aria-label="anchor" href="#chunk-clear"><i class="fas fa-link"></i></a>
</h2>
<p>Before the initial chunk many of our files clear the memory of variables from previous run. This is important when developing and debugging because it prevents previous runs from contaminating subsequent runs. However it has little effect during production; we’ll look at manipulation files separately from analysis files.</p>
<p>Manipulation R files are <a href="https://stat.ethz.ch/R-manual/R-devel/library/base/html/source.html"><code>source</code></a>d with the argument <code>local=new.env()</code>. The file is executed in a fresh environment, so there are no variables to clear. Analysis R files are typically called from an Rmd file’s <code><a href="https://rdrr.io/pkg/knitr/man/read_chunk.html">knitr::read_chunk()</a></code>, and code positioned above the first chunk is not called by knitr <a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;Read more about knitr’s &lt;a href="https://yihui.name/knitr/demo/externalization/"&gt;code externalization&lt;/a&gt;&lt;/p&gt;'><sup>4</sup></a>.</p>
<p>However typically do not clear the memory in R files that are <a href="https://stat.ethz.ch/R-manual/R-devel/library/base/html/source.html"><code>source</code></a>d in the same environment as the caller, as it will interfere with the caller’s variables.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span>list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ls.html">ls</a></span><span class="op">(</span>all.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="chunk-load-sources" class="section level2" number="4.2">
<h2>
<span class="header-section-number">4.2</span> Load Sources<a class="anchor" aria-label="anchor" href="#chunk-load-sources"><i class="fas fa-link"></i></a>
</h2>
<p>In the first true chunk, <a href="https://stat.ethz.ch/R-manual/R-devel/library/base/html/source.html"><code>source</code></a> any R files containing global variables and functions that the current file requires. For instance, when a team of statisticians is producing a large report containing many analysis files, we define many of the graphical elements in a single file. This sourced file defines common color palettes and graphical functions so the cosmetics are more uniform across analyses.</p>
<p>We prefer not to have <code>source</code>d files perform any real action, such as importing data or manipulating a file. One reason is because it is difficult to be consistent about the environmental variables when the sourced file’s functions are run. A second reason is that it more cognitively difficult to understand how the files are connected.</p>
<p>When the sourced file contains only function definitions, these operations can be called at any time in the current file with much tighter control of which variables are modified. A bonus of the discipline of defining functions (instead of executing functions) is that the operations are typically more robust and generalizable.</p>
<p>Keep the chunk even if no files are sourced. An empty chunk is instructive to readers trying to determine if any files are sourced. This applies recommendation applies to all the chunks discussed in this chapter. As always, your team should agree on its own set of standards.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ---- load-sources ------------------------------------------------------------</span></span>
<span><span class="fu">base</span><span class="fu">::</span><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span>file<span class="op">=</span><span class="st">"./analysis/common/display-1.R"</span><span class="op">)</span>      <span class="co"># Load common graphing functions.</span></span></code></pre></div>
</div>
<div id="chunk-load-packages" class="section level2" number="4.3">
<h2>
<span class="header-section-number">4.3</span> Load Packages<a class="anchor" aria-label="anchor" href="#chunk-load-packages"><i class="fas fa-link"></i></a>
</h2>
<p>The ‘load-packages’ chunk declares required packages near the file’s beginning for three reasons. First, a reader scanning the file can quickly determine its dependencies when located in a single chunk. Second, if your machine is lacking a required package, it is best to know early<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;The error message “Error in library(foo) : there is no package called ‘foo’” is easier to understand than “Error in bar() : could not find function ‘bar’” thrown somewhere in the middle of the file; this check can also illuminate conflicts arising when two packages have a &lt;code&gt;bar()&lt;/code&gt; function. See McConnell 2004 Section qqq for more about the ‘fail early’ principle.&lt;/p&gt;"><sup>5</sup></a>. Third, this style mimics a requirement of other languages (such as declaring headers at the top of a C++ file) and follows the <a href="https://style.tidyverse.org/files.html#internal-structure">tidyverse style guide</a>.</p>
<p>As discussed in the previous <a href="#qualify-functions">qualify all functions</a> section, we recommend that functions are qualified with their package (<em>e.g.</em>, <code>foo::bar()</code> instead of merely <code>bar()</code>). Consequently, the ‘load-packages’ chunk calls <code><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace()</a></code> more frequently than <code><a href="https://rdrr.io/r/base/library.html">library()</a></code>. <code><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace()</a></code> verifies the package is available on the local machine, but does not load it into memory; <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> verifies the package is available, and then loads it.</p>
<p><code><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace()</a></code> is not used in several scenarios.</p>
<ol style="list-style-type: decimal">
<li>Core packages (<em>e.g.</em>, ‘base’ and ‘stats’) are loaded by R in most default installations. We avoid unnecessary calls like <code><a href="https://rdrr.io/r/base/library.html">library(stats)</a></code> because they distract from more important features.</li>
<li>Obvious dependencies are not called by <code><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace()</a></code> or <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> for similar reasons, especially if they are not called directly. For example ‘tidyselect’ is not listed when ‘tidyr’ is listed.</li>
<li>
<em>If using a version older than R 4.1</em><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;The “native pipe” (&lt;em&gt;i.e.&lt;/em&gt;, &lt;code&gt;|&amp;gt;&lt;/code&gt;) was introduced in R 4.1, and we strongly recommend you upgrade. If this is not possible, most examples in this book should run by simply replacing &lt;code&gt;|&amp;gt;&lt;/code&gt; with &lt;code&gt;%&amp;gt;%&lt;/code&gt; and calling &lt;code&gt;import::from(magrittr, "%&amp;gt;%")&lt;/code&gt; at the top of each file.&lt;/p&gt;'><sup>6</sup></a>: The “pipe” function (declared in the ‘magrittr’ package , <em>i.e.</em>, <code>%&gt;%</code>) is attached with <code>import::from(magrittr, "%&gt;%")</code>. This frequently-used function can be called throughout the execution without qualification.</li>
<li>Compared to manipulation files, our analysis files tend to use many functions in a few concentrated packages so conflicting function names are less common. Typical packages used in analysis are ‘ggplot2’ and ‘lme4’.</li>
</ol>
<p>The <code>source</code>d files above may load their own packages (by calling <code><a href="https://rdrr.io/r/base/library.html">library()</a></code>). It is important that the <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> calls in this file follow the ‘load-sources’ chunk so that identically-named functions (in different packages) are called with the correct precedent. Otherwise identically-named functions will conflict in the namespace with hard-to-predict results.</p>
<p>Read <a href="http://r-pkgs.had.co.nz/namespace.html#search-path"><em>R Packages</em></a> for more about <code><a href="https://rdrr.io/r/base/library.html">library()</a></code>, <code><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace()</a></code>, and their siblings, as well as the larger concepts such as attaching functions into the search path.</p>
<p>Here are packages found in most of our manipulation files. Notice the lesser-known packages have a quick explanation; this helps maintainers decide if the declaration is still necessary. Also notice the packages distributed outside of CRAN (<em>e.g.</em>, GitHub) have a quick commented line to help the user install or update the package.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ---- load-packages -----------------------------------------------------------</span></span>
<span><span class="co"># import::from(magrittr, "%&gt;%" )</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">"readr"</span>     <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">"tidyr"</span>     <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">"dplyr"</span>     <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">"config"</span>    <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">"checkmate"</span> <span class="op">)</span> <span class="co"># Asserts expected conditions</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">"OuhscMunge"</span><span class="op">)</span> <span class="co"># remotes::install_github(repo="OuhscBbmc/OuhscMunge")</span></span></code></pre></div>
</div>
<div id="chunk-declare" class="section level2" number="4.4">
<h2>
<span class="header-section-number">4.4</span> Declare Globals<a class="anchor" aria-label="anchor" href="#chunk-declare"><i class="fas fa-link"></i></a>
</h2>
<p>When values are repeatedly used within a file, consider dedicating a variable so it’s defined and set only once. This is also a good place for variables that are used only once, but whose value are central to the file’s mission. Typical variables in our ‘declare-globals’ chunk include data file paths, data file variables, color palettes, and values in the <em>config</em> file.</p>
<p>The <a href="prototype-repo.html#repo-root">config file</a> can coordinate a static variable across multiple files. Centrally</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ---- declare-globals ---------------------------------------------------------</span></span>
<span><span class="co"># Constant values that won't change.</span></span>
<span><span class="va">config</span>                         <span class="op">&lt;-</span> <span class="fu">config</span><span class="fu">::</span><span class="fu">get</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">path_db</span>                        <span class="op">&lt;-</span> <span class="va">config</span><span class="op">$</span><span class="va">path_database</span></span>
<span></span>
<span><span class="co"># Execute to specify the column types.  It might require some manual adjustment (eg doubles to integers).</span></span>
<span><span class="co">#   OuhscMunge::readr_spec_aligned(config$path_subject_1_raw)</span></span>
<span><span class="va">col_types</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu">cols_only</span><span class="op">(</span></span>
<span>  subject_id          <span class="op">=</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu">col_integer</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  county_id           <span class="op">=</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu">col_integer</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  gender_id           <span class="op">=</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu">col_double</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  race                <span class="op">=</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu">col_character</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  ethnicity           <span class="op">=</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu">col_character</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div id="chunk-load-data" class="section level2" number="4.5">
<h2>
<span class="header-section-number">4.5</span> Load Data<a class="anchor" aria-label="anchor" href="#chunk-load-data"><i class="fas fa-link"></i></a>
</h2>
<p>All data ingested by this file occurs in this chunk. We like to think of each file as a linear pipe with a single point of input and single point of output. Although it is possible for a file to read data files on any line, we recommend avoiding this sprawl because it is more difficult for humans to understand. If the software developer is a deist watchmaker, the file’s fate has been sealed by the end of this chunk. This makes is easier for a human to reason to isolate problems as either existing with (a) the incoming data or (b) the calculations on that data.</p>
<p>Ideally this chunk consumes data from either a plain-text csv or a database.</p>
<p>Many capable R functions and packages ingest data. We prefer the tidyverse <a href="https://readr.tidyverse.org/">readr</a> for reading conventional files; its younger cousin, <a href="https://vroom.r-lib.org/">vroom</a> has some nice advantages when working with larger files and some forms of jagged rectangles<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;Say a csv has 20 columns, but a row has missing values for the last five columns. Instead of five successive commas to indicate five empty cells exist, a jagged rectangle simply ends after the last nonmissing value. vroom infers the missing values correctly, while some other packages do not.&lt;/p&gt;"><sup>7</sup></a>. Depending on the file format, good packages to consider are <a href="https://cran.r-project.org/package=data.table">data.table</a>, <a href="https://haven.tidyverse.org/">haven</a>, <a href="https://readxl.tidyverse.org/">readxl</a>, <a href="https://ycphs.github.io/openxlsx/">openxlsx</a>, <a href="https://CRAN.R-project.org/package=arrow">arrow</a>, <a href="https://CRAN.R-project.org/package=jsonlite">jsonlite</a>, <a href="http://www.fstpackage.org/">fst</a>, <a href="https://CRAN.R-project.org/package=yaml">yaml</a>, and <a href="https://cloud.r-project.org/web/packages/rio/vignettes/rio.html">rio</a>.</p>
<p>When used in an <a href="patterns.html#pattern-ellis">Ellis</a>, this chunk likely consumes a flat file like a csv with data or metadata. When used in a <a href="patterns.html#pattern-ferry">Ferry</a>, <a href="patterns.html#pattern-arch">Arch</a>, or <a href="patterns.html#pattern-scribe">Scribe</a>, this chunk likely consumes a database table. When used in an <a href="patterns.html#pattern-analysis">Analysis file</a>, this chunk likely consumes a database table or rds (<em>i.e.</em>, a compressed R data file).</p>
<p>In some large-scale scenarios, there may be a series of datasets that cannot be held in RAM simultaneously. Our first choice is to split the R file so each new file has only a subset of the datasets –in other words, the R file probably was given too much responsibility. Occassionaly the multiple datasets need to be considered at once, so splitting the R file is not a option. In these scenarios, we prefer to upload all the datasets to a database, which is better manipulating datasets too large for RAM.</p>
<p>An R solution may be to loosen the restriction that dataset enter the R file only during the ‘load-data’ chunk. Once a dataset is processed and no longer needed, <code><a href="https://rdrr.io/r/base/rm.html">rm()</a></code> <em>r</em>e<em>m</em>oves it from RAM. Now another dataset can be read from a file and manipulated.</p>
<p><em>loose scrap</em>:
the chunk reads all data (<em>e.g.</em>, database table, networked CSV, local lookup table). After this chunk, no new data should be introduced. This is for the sake of reducing human cognition load. Everything below this chunk is derived from these first four chunks.</p>
</div>
<div id="chunk-tweak-data" class="section level2" number="4.6">
<h2>
<span class="header-section-number">4.6</span> Tweak Data<a class="anchor" aria-label="anchor" href="#chunk-tweak-data"><i class="fas fa-link"></i></a>
</h2>
<p><em>loose scrap</em>:
It’s best to rename the dataset (a) in a single place and (b) early in the pipeline, so the bad variable are never referenced.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># OuhscMunge::column_rename_headstart(ds) # Help write `dplyr::select()` call.</span></span>
<span><span class="va">ds</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">ds</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu">select</span><span class="op">(</span>    <span class="co"># `dplyr::select()` drops columns not included.</span></span>
<span>    <span class="va">subject_id</span>,</span>
<span>    <span class="va">county_id</span>,</span>
<span>    <span class="va">gender_id</span>,</span>
<span>    <span class="va">race</span>,</span>
<span>    <span class="va">ethnicity</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu">mutate</span><span class="op">(</span></span>
<span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu">arrange</span><span class="op">(</span><span class="va">subject_id</span><span class="op">)</span> <span class="co"># |&gt;</span></span>
<span>  <span class="co"># tibble::rowid_to_column("subject_id") # Add a unique index if necessary</span></span></code></pre></div>
</div>
<div id="chunk-unique" class="section level2" number="4.7">
<h2>
<span class="header-section-number">4.7</span> (Unique Content)<a class="anchor" aria-label="anchor" href="#chunk-unique"><i class="fas fa-link"></i></a>
</h2>
<p>This section represents all the chunks between <a href="prototype-r.html#chunk-tweak-data">tweak-data</a> and <a href="prototype-r.html#chunk-verify-values">verify-values</a>. These chunks contain most of of the file’s creativity and contribution. In a sense, the structure of the first and last chunks allow these middle chunks to focus on concepts instead of plumbing.</p>
<p>For simple files like the ellis of a metadata file, may not even need anything here. But complex analysis files may have 200+ lines distributed across a dozen chunks. We recommend that you create dedicate a chunk to each conceptual stage. If one starts to contain more than ~20 lines, consider if a more granular organization would clarify the code’s intent.</p>
</div>
<div id="chunk-verify-values" class="section level2" number="4.8">
<h2>
<span class="header-section-number">4.8</span> Verify Values<a class="anchor" aria-label="anchor" href="#chunk-verify-values"><i class="fas fa-link"></i></a>
</h2>
<p>Running <code>OuhscMunge::verify_value_headstart(ds)</code> will</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ---- verify-values -----------------------------------------------------------</span></span>
<span><span class="co"># Sniff out problems</span></span>
<span><span class="co"># OuhscMunge::verify_value_headstart(ds)</span></span>
<span><span class="fu">checkmate</span><span class="fu">::</span><span class="fu">assert_integer</span><span class="op">(</span>  <span class="va">ds</span><span class="op">$</span><span class="va">county_month_id</span>    , any.missing<span class="op">=</span><span class="cn">F</span> , lower<span class="op">=</span><span class="fl">1</span>, upper<span class="op">=</span><span class="fl">3080</span>                , unique<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span>
<span><span class="fu">checkmate</span><span class="fu">::</span><span class="fu">assert_integer</span><span class="op">(</span>  <span class="va">ds</span><span class="op">$</span><span class="va">county_id</span>          , any.missing<span class="op">=</span><span class="cn">F</span> , lower<span class="op">=</span><span class="fl">1</span>, upper<span class="op">=</span><span class="fl">77</span>                            <span class="op">)</span></span>
<span><span class="fu">checkmate</span><span class="fu">::</span><span class="fu">assert_date</span><span class="op">(</span>     <span class="va">ds</span><span class="op">$</span><span class="va">month</span>              , any.missing<span class="op">=</span><span class="cn">F</span> , lower<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2012-06-15"</span><span class="op">)</span>, upper<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">checkmate</span><span class="fu">::</span><span class="fu">assert_character</span><span class="op">(</span><span class="va">ds</span><span class="op">$</span><span class="va">county_name</span>        , any.missing<span class="op">=</span><span class="cn">F</span> , pattern<span class="op">=</span><span class="st">"^.{3,12}$"</span>                          <span class="op">)</span></span>
<span><span class="fu">checkmate</span><span class="fu">::</span><span class="fu">assert_integer</span><span class="op">(</span>  <span class="va">ds</span><span class="op">$</span><span class="va">region_id</span>          , any.missing<span class="op">=</span><span class="cn">F</span> , lower<span class="op">=</span><span class="fl">1</span>, upper<span class="op">=</span><span class="fl">20</span>                            <span class="op">)</span></span>
<span><span class="fu">checkmate</span><span class="fu">::</span><span class="fu">assert_numeric</span><span class="op">(</span>  <span class="va">ds</span><span class="op">$</span><span class="va">fte</span>                , any.missing<span class="op">=</span><span class="cn">F</span> , lower<span class="op">=</span><span class="fl">0</span>, upper<span class="op">=</span><span class="fl">40</span>                            <span class="op">)</span></span>
<span><span class="fu">checkmate</span><span class="fu">::</span><span class="fu">assert_logical</span><span class="op">(</span>  <span class="va">ds</span><span class="op">$</span><span class="va">fte_approximated</span>   , any.missing<span class="op">=</span><span class="cn">F</span>                                                <span class="op">)</span></span>
<span><span class="fu">checkmate</span><span class="fu">::</span><span class="fu">assert_numeric</span><span class="op">(</span>  <span class="va">ds</span><span class="op">$</span><span class="va">fte_rolling_median</span> , any.missing<span class="op">=</span><span class="cn">T</span> , lower<span class="op">=</span><span class="fl">0</span>, upper<span class="op">=</span><span class="fl">40</span>                            <span class="op">)</span></span>
<span></span>
<span><span class="va">county_month_combo</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">ds</span><span class="op">$</span><span class="va">county_id</span>, <span class="va">ds</span><span class="op">$</span><span class="va">month</span><span class="op">)</span></span>
<span><span class="fu">checkmate</span><span class="fu">::</span><span class="fu">assert_character</span><span class="op">(</span><span class="va">county_month_combo</span>, pattern  <span class="op">=</span><span class="st">"^\\d{1,2} \\d{4}-\\d{2}-\\d{2}$"</span>, any.missing<span class="op">=</span><span class="cn">F</span>, unique<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="chunk-specify-columns" class="section level2" number="4.9">
<h2>
<span class="header-section-number">4.9</span> Specify Output Columns<a class="anchor" aria-label="anchor" href="#chunk-specify-columns"><i class="fas fa-link"></i></a>
</h2>
<p>This chunk:</p>
<ol style="list-style-type: decimal">
<li>verifies these variables exist before uploading,</li>
<li>documents (to troubleshooting developers) these variables are a product of the file, and</li>
<li>reorders the variables to match the expected structure.</li>
</ol>
<p>Variable order is especially important for the database engines/drivers that ignore the variable name, and use only the variable position.</p>
<p>We use the term ‘slim’ because typically this output has fewer variables than the full dataset processed by the file.</p>
<p>If you doubt the variable will be needed downstream, leave it in the <code>dplyr::select()</code>, but commented out. If someone needs it in the future, they’ll easily determine where it might come from, and then uncomment the line (and possibly modify the database table). Once you import a column into a warehouse that multiple people are using, it can be tough to remove without breaking their code.</p>
<p>This chunk follows <a href="prototype-r.html#chunk-verify-values">verify-values</a> because sometimes you want to check the validity of variables that are not consumed downstream. These variables are not important themselves, but an illegal value may reveal a larger problem with the dataset.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Print colnames that `dplyr::select()`  should contain below:</span></span>
<span><span class="co">#   cat(paste0("    ", colnames(ds), collapse=",\n"))</span></span>
<span></span>
<span><span class="co"># Define the subset of columns that will be needed in the analyses.</span></span>
<span><span class="co">#   The fewer columns that are exported, the fewer things that can break downstream.</span></span>
<span></span>
<span><span class="va">ds_slim</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">ds</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># dplyr::slice(1:100) |&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu">select</span><span class="op">(</span></span>
<span>    <span class="va">subject_id</span>,</span>
<span>    <span class="va">county_id</span>,</span>
<span>    <span class="va">gender_id</span>,</span>
<span>    <span class="va">race</span>,</span>
<span>    <span class="va">ethnicity</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">ds_slim</span></span></code></pre></div>
</div>
<div id="save-to-disk-or-database" class="section level2" number="4.10">
<h2>
<span class="header-section-number">4.10</span> Save to Disk or Database<a class="anchor" aria-label="anchor" href="#save-to-disk-or-database"><i class="fas fa-link"></i></a>
</h2>
</div>
<div id="additional-resources" class="section level2" number="4.11">
<h2>
<span class="header-section-number">4.11</span> Additional Resources<a class="anchor" aria-label="anchor" href="#additional-resources"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li>
<span class="citation">(<a href="references.html#ref-gillespie" role="doc-biblioref">Colin Gillespie 2017</a>)</span>, particularly the “Efficient input/output” chapter.</li>
</ul>
</div>
</div>

  <div class="chapter-nav">
<div class="prev"><a href="architecture.html"><span class="header-section-number">3</span> Architecture Principles</a></div>
<div class="next"><a href="prototype-sql.html"><span class="header-section-number">5</span> Prototypical SQL File</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#prototype-r"><span class="header-section-number">4</span> Prototypical R File</a></li>
<li><a class="nav-link" href="#chunk-clear"><span class="header-section-number">4.1</span> Clear Memory</a></li>
<li><a class="nav-link" href="#chunk-load-sources"><span class="header-section-number">4.2</span> Load Sources</a></li>
<li><a class="nav-link" href="#chunk-load-packages"><span class="header-section-number">4.3</span> Load Packages</a></li>
<li><a class="nav-link" href="#chunk-declare"><span class="header-section-number">4.4</span> Declare Globals</a></li>
<li><a class="nav-link" href="#chunk-load-data"><span class="header-section-number">4.5</span> Load Data</a></li>
<li><a class="nav-link" href="#chunk-tweak-data"><span class="header-section-number">4.6</span> Tweak Data</a></li>
<li><a class="nav-link" href="#chunk-unique"><span class="header-section-number">4.7</span> (Unique Content)</a></li>
<li><a class="nav-link" href="#chunk-verify-values"><span class="header-section-number">4.8</span> Verify Values</a></li>
<li><a class="nav-link" href="#chunk-specify-columns"><span class="header-section-number">4.9</span> Specify Output Columns</a></li>
<li><a class="nav-link" href="#save-to-disk-or-database"><span class="header-section-number">4.10</span> Save to Disk or Database</a></li>
<li><a class="nav-link" href="#additional-resources"><span class="header-section-number">4.11</span> Additional Resources</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/OuhscBbmc/data-science-practices-1/blob/main/ch-prototype-r.md">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/OuhscBbmc/data-science-practices-1/edit/main/ch-prototype-r.md">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Collaborative Data Science Practices</strong>" was written by Will Beasley. It was last built on 2024-02-12.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
